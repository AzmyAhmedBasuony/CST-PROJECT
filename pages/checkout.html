<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Checkout- TECHHORA</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="../assets/css/main.css" rel="stylesheet">
    <!-- CSS للـ Modal -->
    <style>
        .modal-content {
            border-radius: 10px;
        }
        .modal-success .modal-header {
            background-color: #d4edda;
            color: #155724;
        }
        .modal-error .modal-header {
            background-color: #f8d7da;
            color: #721c24;
        }
        .checkout-title i {
    color: #ff7e5f; /* اللون اللي تحبه للأيقونة */
}

.checkout-title {
    color: #000; /* اللون الأسود لكلمة Checkout */
}

    </style>
</head>
<body>
    <!-- Enhanced Navigation -->
    <nav class="navbar navbar-expand-lg navbar-light fixed-top">
        <div class="container">
            <a class="navbar-brand" href="../index.html">
                <img src="../assets/images/logo.jpg" width="110px" height="100px" alt="TECHHORA" class="img-fluid">
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" >
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="../index.html">
                            <i class="fas fa-home"></i> Home
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" href="catalog.html">
                            <i class="fas fa-th-large"></i> Products
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="about.html">
                            <i class="fas fa-info-circle"></i> About
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="contact.html">
                            <i class="fas fa-envelope"></i> Contact
                        </a>
                    </li>
                </ul>
                <ul class="navbar-nav">
                    <li class="nav-item position-relative">
                        <a class="nav-link" href="cart.html">
                            <i class="fas fa-shopping-cart"></i> Cart
                            <span class="badge cart-count">0</span>
                        </a>
                    </li>
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="#" id="userDropdown" role="button" data-bs-toggle="dropdown">
                            <i class="fas fa-user-circle"></i> Account
                        </a>
                        <ul class="dropdown-menu">
                            <li><a class="dropdown-item" href="login.html">
                                <i class="fas fa-sign-in-alt"></i> Login
                            </a></li>
                            <li><a class="dropdown-item" href="register.html">
                                <i class="fas fa-user-plus"></i> Register
                            </a></li>
                            <li><hr class="dropdown-divider"></li>
                            <li><a class="dropdown-item" href="dashboard/customer.html">
                                <i class="fas fa-tachometer-alt"></i> My Dashboard
                            </a></li>
                            <li><a class="dropdown-item" href="dashboard/seller.html">
                                <i class="fas fa-store"></i> Seller Dashboard
                            </a></li>
                            <li><a class="dropdown-item" href="dashboard/admin.html">
                                <i class="fas fa-shield-alt"></i> Admin Panel
                            </a></li>
                        </ul>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="container my-5">
        <!-- Modal للإشعارات -->
        <div class="modal fade" id="notificationModal" tabindex="-1" aria-labelledby="notificationModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="notificationModalLabel">Notification</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body" id="notificationModalBody"></div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-primary" data-bs-dismiss="modal">OK</button>
                    </div>
                </div>
            </div>
        </div>

        <div class="row">
            <!-- Checkout Form -->
            <div class="col-lg-8">
                <h2 class="mb-4 checkout-title">
                    <i class="fas fa-credit-card"></i>
                    Checkout
                </h2>
                

                <!-- Progress Steps -->
                <div class="progress mb-4" style="height: 2px;">
                    <div class="progress-bar" role="progressbar" style="width: 25%;" aria-valuenow="25" aria-valuemin="0" aria-valuemax="100"></div>
                </div>
                <div class="row text-center mb-4">
                    <div class="col-3">
                        <div class="step active">
                            <i class="fas fa-shopping-cart"></i>
                            <small>Cart</small>
                        </div>
                    </div>
                    <div class="col-3">
                        <div class="step">
                            <i class="fas fa-shipping-fast"></i>
                            <small>Shipping</small>
                        </div>
                    </div>
                    <div class="col-3">
                        <div class="step">
                            <i class="fas fa-credit-card"></i>
                            <small>Payment</small>
                        </div>
                    </div>
                    <div class="col-3">
                        <div class="step">
                            <i class="fas fa-check"></i>
                            <small>Confirm</small>
                        </div>
                    </div>
                </div>

                <!-- Checkout Form -->
                <form id="checkoutForm">
                    <!-- Shipping Information -->
                    <div class="card mb-4">
                        <div class="card-header">
                            <h5 class="mb-0">
                                <i class="fas fa-shipping-fast me-2"></i>
                                Shipping Information
                            </h5>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="firstName" class="form-label">First Name *</label>
                                    <input type="text" class="form-control" id="firstName" required>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label for="lastName" class="form-label">Last Name *</label>
                                    <input type="text" class="form-control" id="lastName" required>
                                </div>
                            </div>
                            <div class="mb-3">
                                <label for="email" class="form-label">Email Address *</label>
                                <input type="email" class="form-control" id="email" required>
                            </div>
                            <div class="mb-3">
                                <label for="phone" class="form-label">Phone Number *</label>
                                <input type="tel" class="form-control" id="phone" required>
                            </div>
                            <div class="mb-3">
                                <label for="address" class="form-label">Street Address *</label>
                                <input type="text" class="form-control" id="address" required>
                            </div>
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="city" class="form-label">City *</label>
                                    <input type="text" class="form-control" id="city" required>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label for="zipCode" class="form-label">ZIP Code *</label>
                                    <input type="text" class="form-control" id="zipCode" required>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Shipping Options -->
                    <div class="card mb-4">
                        <div class="card-header">
                            <h5 class="mb-0">
                                <i class="fas fa-truck me-2"></i>
                                Shipping Options
                            </h5>
                        </div>
                        <div class="card-body">
                            <div class="form-check mb-3">
                                <input class="form-check-input" type="radio" name="shipping" id="standard" value="standard" checked>
                                <label class="form-check-label" for="standard">
                                    <strong>Standard Shipping (3-5 business days)</strong>
                                    <br>
                                    <small class="text-muted">Free for orders over $50</small>
                                </label>
                                <span class="float-end">$5.99</span>
                            </div>
                            <div class="form-check mb-3">
                                <input class="form-check-input" type="radio" name="shipping" id="express" value="express">
                                <label class="form-check-label" for="express">
                                    <strong>Express Shipping (1-2 business days)</strong>
                                    <br>
                                    <small class="text-muted">Priority handling</small>
                                </label>
                                <span class="float-end">$12.99</span>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="shipping" id="overnight" value="overnight">
                                <label class="form-check-label" for="overnight">
                                    <strong>Overnight Shipping</strong>
                                    <br>
                                    <small class="text-muted">Next business day delivery</small>
                                </label>
                                <span class="float-end">$24.99</span>
                            </div>
                        </div>
                    </div>

                    <!-- Payment Information -->
                    <div class="card mb-4">
                        <div class="card-header">
                            <h5 class="mb-0">
                                <i class="fas fa-credit-card me-2"></i>
                                Payment Information
                            </h5>
                        </div>
                        <div class="card-body">
                            <div class="mb-3">
                                <label for="cardNumber" class="form-label">Card Number *</label>
                                <input type="text" class="form-control" id="cardNumber" placeholder="1234 5678 9012 3456" required>
                            </div>
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="expiryDate" class="form-label">Expiry Date *</label>
                                    <input type="text" class="form-control" id="expiryDate" placeholder="MM/YY" required>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label for="cvv" class="form-label">CVV *</label>
                                    <input type="text" class="form-control" id="cvv" placeholder="123" required>
                                </div>
                            </div>
                            <div class="mb-3">
                                <label for="cardName" class="form-label">Name on Card *</label>
                                <input type="text" class="form-control" id="cardName" required>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="saveCard">
                                <label class="form-check-label" for="saveCard">
                                    Save this card for future purchases
                                </label>
                            </div>
                        </div>
                    </div>

                    <!-- Order Notes -->
                    <div class="card mb-4">
                        <div class="card-header">
                            <h5 class="mb-0">
                                <i class="fas fa-sticky-note me-2"></i>
                                Order Notes (Optional)
                            </h5>
                        </div>
                        <div class="card-body">
                            <textarea class="form-control" id="orderNotes" rows="3" placeholder="Any special instructions for your order..."></textarea>
                        </div>
                    </div>
                </form>
            </div>

            <!-- Order Summary -->
            <div class="col-lg-4 mt-5">
                <div class="card sticky-top" style="top: 90px;">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="fas fa-receipt me-2"></i>
                            Order Summary
                        </h5>
                    </div>
                    <div class="card-body">
                        <div id="orderItems">
                            <!-- Order items will be populated here -->
                        </div>
                        
                        <hr>
                        
                        <div class="d-flex justify-content-between mb-2">
                            <span>Subtotal:</span>
                            <span id="subtotal">$0.00</span>
                        </div>
                        <div class="d-flex justify-content-between mb-2">
                            <span>Shipping:</span>
                            <span id="shippingCost">$5.99</span>
                        </div>
                        <div class="d-flex justify-content-between mb-2">
                            <span>Tax:</span>
                            <span id="taxAmount">$0.00</span>
                        </div>
                        <hr>
                        <div class="d-flex justify-content-between mb-3">
                            <strong>Total:</strong>
                            <strong id="totalAmount">$0.00</strong>
                        </div>
                        
                        <button type="submit" form="checkoutForm" class="btn btn-primary btn-lg w-100 mb-3">
                            <i class="fas fa-lock me-2"></i>
                            Place Order
                        </button>
                        
                        <div class="text-center">
                            <small class="text-muted">
                                <i class="fas fa-shield-alt me-1"></i>
                                Your payment is secure and encrypted
                            </small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer class="bg-dark text-light py-4 mt-5">
        <div class="container">
            <div class="row">
                <div class="col-md-6">
                    <img src="../assets/images/logo-footer.jpg" width="110px" height="100px" alt="TECHHORA" class="img-fluid">
                    <p>Your trusted source for quality electronics and tech products.</p>
                </div>
                <div class="col-md-6 text-md-end">
                    <p>&copy; 2025 TECHHORA. All rights reserved.</p>
                    <div class="social-links">
                        <a href="#" class="text-light me-3"><i class="fab fa-facebook"></i></a>
                        <a href="#" class="text-light me-3"><i class="fab fa-twitter"></i></a>
                        <a href="#" class="text-light me-3"><i class="fab fa-instagram"></i></a>
                        <a href="#" class="text-light"><i class="fab fa-linkedin"></i></a>
                    </div>
                </div>
            </div>
        </div>
    </footer>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <!-- Main JS -->
    <script src="../assets/js/main.js"></script>
    <script src="../assets/js/auth.js"></script>
    <script src="../assets/js/cart.js"></script>
    
    <script>
        // Checkout page specific JavaScript
        document.addEventListener('DOMContentLoaded', function() {
            loadOrderSummary();
            setupCheckoutForm();
        });
    
        function loadOrderSummary() {
            const cart = JSON.parse(localStorage.getItem('cart') || '[]');
            const orderItemsContainer = document.getElementById('orderItems');
            
            if (cart.length === 0) {
                orderItemsContainer.innerHTML = '<p class="text-muted">No items in cart</p>';
                return;
            }
    
            let itemsHtml = '';
            let subtotal = 0;
    
            cart.forEach(item => {
                const itemTotal = item.price * item.quantity;
                subtotal += itemTotal;
                
                itemsHtml += `
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <div>
                            <strong>${item.name}</strong>
                            <br>
                            <small class="text-muted">Qty: ${item.quantity}</small>
                        </div>
                        <span>$${itemTotal.toFixed(2)}</span>
                    </div>
                `;
            });
    
            orderItemsContainer.innerHTML = itemsHtml;
            
            // Update totals
            const shippingCost = 5.99;
            const taxRate = 0.08; // 8% tax
            const taxAmount = subtotal * taxRate;
            const total = subtotal + shippingCost + taxAmount;
    
            document.getElementById('subtotal').textContent = `$${subtotal.toFixed(2)}`;
            document.getElementById('shippingCost').textContent = `$${shippingCost.toFixed(2)}`;
            document.getElementById('taxAmount').textContent = `$${taxAmount.toFixed(2)}`;
            document.getElementById('totalAmount').textContent = `$${total.toFixed(2)}`;
        }
    
        function setupCheckoutForm() {
            const form = document.getElementById('checkoutForm');
            
            form.addEventListener('submit', function(e) {
                e.preventDefault();
                console.log('Form submitted'); // Debug: Confirm submit event
                if (!isLoggedIn || !isLoggedIn()) {
                    showNotification('Please login to complete your order.', 'error');
                    setTimeout(() => {
                        window.location.href = 'login.html';
                    }, 2000);
                    return;
                }
    
                // Validate form
                if (!validateCheckoutForm()) {
                    console.log('Validation failed'); // Debug: Check validation
                    return;
                }
    
                // Process order
                console.log('Processing order'); // Debug: Confirm order processing
                processOrder();
            });
    
            // Shipping cost update
            document.querySelectorAll('input[name="shipping"]').forEach(radio => {
                radio.addEventListener('change', function() {
                    const shippingCosts = {
                        'standard': 5.99,
                        'express': 12.99,
                        'overnight': 24.99
                    };
                    
                    const selectedShipping = this.value;
                    const shippingCost = shippingCosts[selectedShipping];
                    
                    document.getElementById('shippingCost').textContent = `$${shippingCost.toFixed(2)}`;
                    updateTotal();
                });
            });
        }
    
        function validateCheckoutForm() {
            const requiredFields = [
                'firstName', 'lastName', 'email', 'phone', 'address', 
                'city', 'zipCode', 'cardNumber', 'expiryDate', 'cvv', 'cardName'
            ];
    
            for (let field of requiredFields) {
                const element = document.getElementById(field);
                if (!element.value.trim()) {
                    showNotification(`Please fill in ${field.replace(/([A-Z])/g, ' $1').toLowerCase()}.`, 'error');
                    element.focus();
                    return false;
                }
            }
    
            // Validate email
            const email = document.getElementById('email').value;
            if (!isValidEmail(email)) {
                showNotification('Please enter a valid email address.', 'error');
                return false;
            }
    
            // Validate card number (basic validation)
            const cardNumber = document.getElementById('cardNumber').value.replace(/\s/g, '');
            if (cardNumber.length < 13 || cardNumber.length > 19) {
                showNotification('Please enter a valid card number.', 'error');
                return false;
            }
    
            return true;
        }
    
        // Fallback for isValidEmail if not defined in auth.js
        function isValidEmail(email) {
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            return emailRegex.test(email);
        }
    
        // Updated showNotification to use Bootstrap Modal
        function showNotification(message, type) {
            console.log(`Notification: ${message} (${type})`); // Debug: Log notification
            
            const modalElement = document.getElementById('notificationModal');
            const modalBody = document.getElementById('notificationModalBody');
            const modalTitle = document.getElementById('notificationModalLabel');
            const modalHeader = modalElement.querySelector('.modal-header');

            // Set modal content and style
            modalBody.innerHTML = message; // Use innerHTML to support <br> tags
            modalTitle.textContent = type === 'success' ? 'Success' : 'Error';
            modalHeader.classList.remove('modal-success', 'modal-error');
            modalHeader.classList.add(type === 'success' ? 'modal-success' : 'modal-error');

            // Initialize and show the modal
            const modal = new bootstrap.Modal(modalElement, {
                backdrop: 'static',
                keyboard: false
            });
            modal.show();
        }
    
        function processOrder() {
            const cart = JSON.parse(localStorage.getItem('cart') || '[]');
            if (cart.length === 0) {
                showNotification('Your cart is empty.', 'error');
                return;
            }
    
            // Create order object
            const order = {
                id: 'ORD' + Date.now(),
                customer: getCurrentUser(),
                items: cart,
                shipping: {
                    firstName: document.getElementById('firstName').value,
                    lastName: document.getElementById('lastName').value,
                    email: document.getElementById('email').value,
                    phone: document.getElementById('phone').value,
                    address: document.getElementById('address').value,
                    city: document.getElementById('city').value,
                    zipCode: document.getElementById('zipCode').value
                },
                payment: {
                    cardNumber: document.getElementById('cardNumber').value.replace(/\s/g, '').slice(-4),
                    cardName: document.getElementById('cardName').value
                },
                shippingMethod: document.querySelector('input[name="shipping"]:checked').value,
                notes: document.getElementById('orderNotes').value,
                status: 'pending',
                createdAt: new Date().toISOString(),
                total: parseFloat(document.getElementById('totalAmount').textContent.replace('$', ''))
            };
    
            // Save order
            const orders = JSON.parse(localStorage.getItem('orders') || '[]');
            orders.push(order);
            localStorage.setItem('orders', JSON.stringify(orders));
    
            // Clear cart
            localStorage.removeItem('cart');
    
            // Show success message
            showNotification('Order placed successfully! You will receive a confirmation email shortly.', 'success');
            
            // Redirect to order confirmation
            setTimeout(() => {
                window.location.href = 'dashboard/customer.html';
            }, 2000);
        }
    
        function updateTotal() {
            const subtotal = parseFloat(document.getElementById('subtotal').textContent.replace('$', ''));
            const shippingCost = parseFloat(document.getElementById('shippingCost').textContent.replace('$', ''));
            const taxAmount = subtotal * 0.08;
            const total = subtotal + shippingCost + taxAmount;
    
            document.getElementById('taxAmount').textContent = `$${taxAmount.toFixed(2)}`;
            document.getElementById('totalAmount').textContent = `$${total.toFixed(2)}`;
        }
    </script>
</body>
</html>